import{p as K}from"./app-Ddl2Q9KC.js";K.registerAddon((r,y,F)=>{r.Tree||={};const x=t=>({value:t,writable:!1,enumerable:!0,configurable:!1});Object.defineProperties(r.Tree,{VERSION:x("0.0.3"),NONE:x(0),WORLD:x("WORLD"),EYE:x("EYE"),NDC:x("NDC"),SCREEN:x("SCREEN"),MODEL:x("MODEL"),OBJECT:x("MODEL"),ORIGIN:x(Object.freeze([0,0,0])),i:x(Object.freeze([1,0,0])),j:x(Object.freeze([0,1,0])),k:x(Object.freeze([0,0,1])),_i:x(Object.freeze([-1,0,0])),_j:x(Object.freeze([0,-1,0])),_k:x(Object.freeze([0,0,-1])),X:x(1),_X:x(2),Y:x(4),_Y:x(8),Z:x(16),_Z:x(32),LABELS:x(64),CIRCLE:x(0),SQUARE:x(1),NEAR:x(1),FAR:x(2),LEFT:x(4),RIGHT:x(8),BOTTOM:x(16),TOP:x(32),BODY:x(64),APEX:x(128),INVISIBLE:x(0),VISIBLE:x(1),SEMIVISIBLE:x(2)});const g=function(t){const e=t._renderer;return e instanceof r.RendererGL?e:void 0},V=function(t){const e=t.clone();return e.invert(t),e},z=function(t){const e=t.mat4;if(e)return new r.Matrix([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]]);const n=t.mat3;if(n)return new r.Matrix([n[0],n[3],n[6],n[1],n[4],n[7],n[2],n[5],n[8]])};r.Matrix.prototype.mult4=function(t){return new r.Vector(...this._mult4([t.x,t.y,t.z,1]))},r.Matrix.prototype._mult4=function(t){if(this.mat4===void 0){console.error("_mult4 only works with mat4");return}return[this.mat4[0]*t[0]+this.mat4[4]*t[1]+this.mat4[8]*t[2]+this.mat4[12]*t[3],this.mat4[1]*t[0]+this.mat4[5]*t[1]+this.mat4[9]*t[2]+this.mat4[13]*t[3],this.mat4[2]*t[0]+this.mat4[6]*t[1]+this.mat4[10]*t[2]+this.mat4[14]*t[3],this.mat4[3]*t[0]+this.mat4[7]*t[1]+this.mat4[11]*t[2]+this.mat4[15]*t[3]]},y.tMatrix=function(t){return z(t)},y.iMatrix=function(t){return V(t)},y.axbMatrix=function(t,e){return t.clone().mult(e)},y.createMatrix=(...t)=>new r.Matrix(...t),r.RendererGL.prototype.pMatrix=function(){return this.states.uPMatrix.clone()},y.pMatrix=function(){return g(this).pMatrix()},r.RendererGL.prototype.mMatrix=function(){return this.states.uModelMatrix.clone()},y.mMatrix=function(){return g(this).mMatrix()},r.Camera.prototype.vMatrix=function(){return this.cameraMatrix.clone()},r.Camera.prototype.eMatrix=function(){return V(this.cameraMatrix)},r.RendererGL.prototype.vMatrix=function(){return(this.states.uViewMatrix||this.states.curCamera.cameraMatrix).clone()},y.vMatrix=function(){return g(this).vMatrix()},r.RendererGL.prototype.eMatrix=function(){return V(this.states.uViewMatrix||this.states.curCamera.cameraMatrix)},y.eMatrix=function(){return g(this).eMatrix()},r.RendererGL.prototype.lMatrix=function({from:t=new r.Matrix(4),to:e=this.eMatrix()}={}){return V(e).mult(t)},y.lMatrix=function(t={}){return g(this).lMatrix(t)},r.RendererGL.prototype.dMatrix=function({from:t=new r.Matrix(4),to:e=this.eMatrix(),matrix:n}={}){const s=n||V(t).mult(e),i=s.mat4||s.matrix;return new r.Matrix([i[0],i[4],i[8],i[1],i[5],i[9],i[2],i[6],i[10]])},y.dMatrix=function(t={}){return g(this).dMatrix(t)},r.RendererGL.prototype.mvMatrix=function({vMatrix:t=this.vMatrix(),mMatrix:e}={}){return(e||this.states.uModelMatrix).clone().mult(t)},y.mvMatrix=function(t={}){return g(this).mvMatrix(t)},r.RendererGL.prototype.nMatrix=function({vMatrix:t,mMatrix:e,mvMatrix:n=this.mvMatrix({mMatrix:e,vMatrix:t})}={}){return z(V(n.createSubMatrix3x3()))},y.nMatrix=function(t={}){return g(this).nMatrix(t)},r.RendererGL.prototype.pmvMatrix=function({pMatrix:t=this.pMatrix(),vMatrix:e,mMatrix:n,mvMatrix:s}={}){return(s?s.clone():this.mvMatrix({mMatrix:n,vMatrix:e})).mult(t)},y.pmvMatrix=function(t={}){return g(this).pmvMatrix(t)},r.RendererGL.prototype.pvMatrix=function({pMatrix:t=this.pMatrix(),vMatrix:e}={}){return(e||this.states.uViewMatrix||this.states.curCamera.cameraMatrix).clone().mult(t)},y.pvMatrix=function(t={}){return g(this).pvMatrix(t)},r.RendererGL.prototype.ipvMatrix=function({pMatrix:t,vMatrix:e,pvMatrix:n=this.pvMatrix({pMatrix:t,vMatrix:e})}={}){return V(n)},y.ipvMatrix=function(t={}){return g(this).ipvMatrix(t)},r.Matrix.prototype.isOrtho=function(){return this.mat4[15]!==0},r.RendererGL.prototype.isOrtho=function(){return this.pMatrix().isOrtho()},y.isOrtho=function(){return g(this).isOrtho()},r.Matrix.prototype.nPlane=function(){const t=this.mat4;return t[15]===0?t[14]/(t[10]-1):(1+t[14])/t[10]},r.Matrix.prototype.fPlane=function(){const t=this.mat4;return t[15]===0?t[14]/(1+t[10]):(t[14]-1)/t[10]},r.Matrix.prototype.lPlane=function(){const t=this.mat4;return t[15]===1?-(1+t[12])/t[0]:this.nPlane()*(t[8]-1)/t[0]},r.Matrix.prototype.rPlane=function(){const t=this.mat4;return t[15]===1?(1-t[12])/t[0]:this.nPlane()*(1+t[8])/t[0]},r.Matrix.prototype.tPlane=function(){const t=this.mat4;return t[15]===1?(t[13]-1)/t[5]:this.nPlane()*(t[9]-1)/t[5]},r.Matrix.prototype.bPlane=function(){const t=this.mat4;return t[15]===1?(1+t[13])/t[5]:this.nPlane()*(1+t[9])/t[5]},r.RendererGL.prototype.nPlane=function(){return this.pMatrix().nPlane()},r.RendererGL.prototype.fPlane=function(){return this.pMatrix().fPlane()},r.RendererGL.prototype.lPlane=function(){return this.pMatrix().lPlane()},r.RendererGL.prototype.rPlane=function(){return this.pMatrix().rPlane()},r.RendererGL.prototype.tPlane=function(){return this.pMatrix().tPlane()},r.RendererGL.prototype.bPlane=function(){return this.pMatrix().bPlane()},y.nPlane=function(){return g(this).nPlane()},y.fPlane=function(){return g(this).fPlane()},y.lPlane=function(){return g(this).lPlane()},y.rPlane=function(){return g(this).rPlane()},y.tPlane=function(){return g(this).tPlane()},y.bPlane=function(){return g(this).bPlane()},r.Matrix.prototype.fov=function(){if(this.mat4[15]!==0){console.error("[tree.matrix] fov only works for a perspective projection.");return}return Math.abs(2*Math.atan(1/this.mat4[5]))},r.Matrix.prototype.hfov=function(){if(this.mat4[15]!==0){console.error("[tree.matrix] hfov only works for a perspective projection.");return}return Math.abs(2*Math.atan(1/this.mat4[0]))},r.RendererGL.prototype.fov=function(){return this.pMatrix().fov()},r.RendererGL.prototype.hfov=function(){return this.pMatrix().hfov()},y.fov=function(){return g(this).fov()},y.hfov=function(){return g(this).hfov()};const B=Symbol.for("tree.camera.path.state"),j=Symbol.for("tree.camera.path.players"),H=function(t){return t<0?0:t>1?1:t},W=function(t){return typeof t=="number"&&Number.isFinite(t)},I=function(t){console.warn("[tree.camera.path] "+t)},N=function(t){return t.path||(t.path=[]),t.path},G=function(t){return Math.max(0,t.length-1)},C=function(t){return t[B]||(t[B]={playing:!1,loop:!1,pingPong:!1,onEnd:void 0,rate:1,duration:30,seg:0,f:0,pathIsOrtho:void 0}),t[B]},A=function(t){return t[j]||(t[j]=new Set),t[j]},k=function(t){const e=t&&t._renderer;return e&&e.states&&e.states.curCamera||e&&(e._curCamera||e.curCamera||e._camera)||void 0},v=function(t,e){const n=N(t),s=G(n);if(s===0)return;const i=C(t),o=H(e)*s,c=Math.min(s-1,Math.floor(o)),f=o-c;t.slerp(n[c],n[c+1],f),i.seg=c,i.f=Math.round(f*Math.max(1,i.duration|0))},U=function(t,e,n){const s=N(t),i=G(s);if(i===0)return;const a=C(t),o=Math.max(0,Math.min(n|0,i-1)),c=H(e);t.slerp(s[o],s[o+1],c),a.seg=o,a.f=Math.round(c*Math.max(1,a.duration|0))},q=function(t){const e=C(t);if(!e.playing)return;const n=N(t),s=G(n);if(s===0){e.playing=!1;return}const i=Math.max(1,e.duration|0),a=Math.abs(e.rate);if(a===0){e.playing=!1;return}let o=e.rate>=0?1:-1;for(e.f+=a;e.f>=i;)if(e.f-=i,e.seg+=o,e.seg>=s||e.seg<0)if(e.pingPong)o>0?(e.seg=s-1,e.f=0,e.rate=-a):(e.seg=0,e.f=0,e.rate=a),o=e.rate>=0?1:-1;else if(e.loop)e.seg=o>0?0:s-1;else{e.playing=!1,v(t,o>0?1:0);const u=e.onEnd;if(typeof u=="function")try{u(t)}catch{}return}const c=e.f/i,f=o>0?c:1-c;t.slerp(n[e.seg],n[e.seg+1],f)};F.predraw=function(){const t=A(this);t.forEach(e=>{q(e),C(e).playing||t.delete(e)})},F.remove=function(){const t=this[j];t&&t.clear()},r.Camera.prototype.addPath=function(...t){const e=C(this),n=N(this),s=h=>!h||typeof h!="object"||Array.isArray(h)||ArrayBuffer.isView(h)?!1:Object.getPrototypeOf(h)===Object.prototype,i=h=>h instanceof r.Vector||Array.isArray(h)&&h.length===3&&h.every(l=>typeof l=="number"&&Number.isFinite(l)),a=h=>h instanceof r.Vector?[h.x,h.y,h.z]:[h[0],h[1],h[2]],o=function(h,l){if(!h||!l)return!1;const L=h.cameraMatrix&&h.cameraMatrix.mat4,M=l.cameraMatrix&&l.cameraMatrix.mat4;if(!L||!M)return!1;for(let S=0;S<16;S++)if(L[S]!==M[S])return!1;return!0},c=h=>{const l=n.length?n[n.length-1]:void 0;l&&o(l,h)||n.push(h.copy())},f=h=>{const l=h&&h.projMatrix&&h.projMatrix.mat4;return l&&l.length===16?l[15]!==0:void 0},u=h=>{if(e.pathIsOrtho!==void 0)return;const l=f(h);e.pathIsOrtho=l,l===void 0&&I("addPath: unable to verify projection type (projMatrix.mat4 unavailable).")},d=h=>{u(h);const l=f(h);return e.pathIsOrtho===void 0||l===void 0?(l===void 0&&I("addPath: unable to verify projection type (projMatrix.mat4 unavailable)."),!0):l!==e.pathIsOrtho?(I("addPath rejected: keyframe has different projection type (ortho vs perspective)."),!1):!0},E=h=>(Array.isArray(h)||ArrayBuffer.isView(h))&&h.length===16&&Array.prototype.every.call(h,l=>typeof l=="number"&&Number.isFinite(l)),m=h=>h instanceof r.Matrix||E(h),T=h=>h instanceof r.Matrix?h.mat4:h,R=(h,l)=>h[0]*l[0]+h[1]*l[1]+h[2]*l[2],P=h=>Math.sqrt(R(h,h)),b=h=>{const l=P(h)||1;return[h[0]/l,h[1]/l,h[2]/l]},_=h=>{const l=T(h),L=b([l[0],l[4],l[8]]),M=b([l[1],l[5],l[9]]),S=b([l[2],l[6],l[10]]),O=[-S[0],-S[1],-S[2]],D=[l[12],l[13],l[14]],w=[-(D[0]*L[0]+D[1]*M[0])+D[2]*O[0],-(D[0]*L[1]+D[1]*M[1])+D[2]*O[1],-(D[0]*L[2]+D[1]*M[2])+D[2]*O[2]],Y=Math.sqrt((this.centerX-this.eyeX)*(this.centerX-this.eyeX)+(this.centerY-this.eyeY)*(this.centerY-this.eyeY)+(this.centerZ-this.eyeZ)*(this.centerZ-this.eyeZ))||1,X=[w[0]+O[0]*Y,w[1]+O[1]*Y,w[2]+O[2]*Y],Z=this.copy();return Z.camera(w[0],w[1],w[2],X[0],X[1],X[2],M[0],M[1],M[2]),Z};if((t.length&&s(t[t.length-1])?t.pop():{}).reset&&(n.length=0,e.seg=0,e.f=0,e.pathIsOrtho=void 0),u(this),t.length===0)return c(this),this;if(t.length===1){const h=t[0];if(m(h)){const l=_(h);return d(l)&&c(l),this}if(Array.isArray(h)){const l=h;if(l.length&&l.every(m)){for(let L=0;L<l.length;L++){const M=_(l[L]);d(M)&&c(M)}return this}for(let L=0;L<l.length;L++){const M=l[L];if(!(M instanceof r.Camera)){I("addPath: ignored non-camera value.");continue}d(M)&&c(M)}return this}return h instanceof r.Camera?(d(h)&&c(h),this):(I("addPath: ignored unsupported arguments."),this)}if(t.length===3&&t.every(i)){const h=a(t[0]),l=a(t[1]),L=b(a(t[2])),M=this.copy();return M.camera(h[0],h[1],h[2],l[0],l[1],l[2],L[0],L[1],L[2]),d(M)&&c(M),this}return I("addPath: ignored unsupported arguments."),this},r.Camera.prototype.playPath=function(t){const e=C(this),n=N(this),s=this._renderer&&this._renderer._pInst,i=()=>s&&A(s).delete(this),a=()=>s&&A(s).add(this);if(n.length===0)return I("playPath ignored: need at least 1 keyframe in camera.path."),e.playing=!1,i(),this;if(n.length===1){const c=n[0];return e.playing=!1,i(),this.camera(c.eyeX,c.eyeY,c.eyeZ,c.centerX,c.centerY,c.centerZ,c.upX,c.upY,c.upZ)}const o=G(n);if(o===0)return I("playPath ignored: need at least 2 keyframes in camera.path."),e.playing=!1,i(),this;if(W(t))e.rate=t;else{const c=t||{};e.duration=W(c.duration)?c.duration:e.duration,e.loop=!!c.loop,e.pingPong=!!c.pingPong,e.onEnd=typeof c.onEnd=="function"?c.onEnd:e.onEnd,e.rate=W(c.rate)?c.rate:e.rate}if(e.rate===0)return e.playing=!1,i(),this;if(!e.playing){const c=e.rate>=0;e.seg=c?0:o-1,e.f=0,this.slerp(n[e.seg],n[e.seg+1],c?0:1)}return e.playing=!0,a(),this},r.Camera.prototype.stopPath=function(t){const e=C(this),n=t||{};e.playing=!1;const s=this._renderer&&this._renderer._pInst;if(s&&A(s).delete(this),n.reset){const i=e.rate>=0;v(this,i?0:1),e.seg=i?0:Math.max(0,G(N(this))-1),e.f=0}return this},r.Camera.prototype.resetPath=function(t){const e=C(this),n=N(this);e.playing=!1,e.seg=0,e.f=0;const s=this._renderer&&this._renderer._pInst;if(s&&A(s).delete(this),!W(t))return n.length=0,e.pathIsOrtho=void 0,this;const i=t|0,a=Math.max(0,Math.abs(i));return a===0?(n.length=0,e.pathIsOrtho=void 0,this):(i>=0?n.length=Math.min(n.length,a):n.length>a&&n.splice(0,n.length-a),G(n)===0&&(e.pathIsOrtho=void 0),this)},r.Camera.prototype.seekPath=function(t,e){const n=C(this);n.playing=!1;const s=this._renderer&&this._renderer._pInst;return s&&A(s).delete(this),W(e)?(U(this,t,e),this):(v(this,t),this)},y.addPath=function(...t){const e=k(this);return e&&e.addPath(...t),this},y.playPath=function(...t){const e=k(this);return e&&e.playPath(...t),this},y.seekPath=function(...t){const e=k(this);return e&&e.seekPath(...t),this},y.resetPath=function(...t){const e=k(this);return e&&e.resetPath(...t),this},y.stopPath=function(...t){const e=k(this);return e&&e.stopPath(...t),this},y.beginHUD=function(...t){return this._renderer?.beginHUD?.(...t),this},y.endHUD=function(...t){return this._renderer?.endHUD?.(...t),this},r.RendererGL.prototype.beginHUD=function(){if(this._hudActive===!0)return;const t=this._pInst;if(!t)return;const e=this.drawingContext,n=this.states;if(!e||!n)return;t.push(),t.resetShader(),t.resetMatrix(),this._hudPrevCam=n.curCamera,this._hudDepthWasEnabled=e.isEnabled(e.DEPTH_TEST),e.flush(),e.disable(e.DEPTH_TEST),this._hudCam===void 0&&(this._hudCam=t.createCamera());const s=1e6;this._hudCam.ortho(0,t.width,-t.height,0,-s,s),this._hudCam.camera(0,0,1,0,0,0,0,1,0),t.setCamera(this._hudCam),this._hudActive=!0},r.RendererGL.prototype.endHUD=function(){if(this._hudActive!==!0)return;const t=this._pInst,e=this.drawingContext,n=this.states;t===void 0||e===void 0||n===void 0||(e.flush(),this._hudDepthWasEnabled?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),t.pop(),this._hudPrevCam!==void 0&&t.setCamera(this._hudPrevCam),this._hudPrevCam=void 0,this._hudDepthWasEnabled=void 0,this._hudActive=!1)},r.RendererGL.prototype._parseTransformArgs=function(t,...e){let n=t;const s={};for(const i of e)i instanceof r.Vector||Array.isArray(i)?n=i:i&&typeof i=="object"&&Object.assign(s,i);return{mainArg:n,options:s}},y.mapLocation=function(...t){return g(this)?.mapLocation(...t)},r.RendererGL.prototype.mapLocation=function(...t){const{mainArg:e,options:n}=this._parseTransformArgs(r.Tree.ORIGIN,...t);return this._location(e,n)},r.RendererGL.prototype._location=function(t=r.Tree.ORIGIN,{from:e=r.Tree.EYE,to:n=r.Tree.WORLD,pMatrix:s,vMatrix:i,eMatrix:a,pvMatrix:o,ipvMatrix:c}={}){return Array.isArray(t)&&(t=new r.Vector(t[0]??0,t[1]??0,t[2]??0)),e==r.Tree.MODEL&&(e=this.mMatrix({eMatrix:a})),n==r.Tree.MODEL&&(n=this.mMatrix({eMatrix:a})),e==r.Tree.WORLD&&n==r.Tree.SCREEN?this._worldToScreenLocation({point:t,pMatrix:s,vMatrix:i,pvMatrix:o}):e==r.Tree.SCREEN&&n==r.Tree.WORLD?this._screenToWorldLocation({point:t,pMatrix:s,vMatrix:i,pvMatrix:o,ipvMatrix:c}):e==r.Tree.SCREEN&&n==r.Tree.NDC?this._screenToNDCLocation(t):e==r.Tree.NDC&&n==r.Tree.SCREEN?this._ndcToScreenLocation(t):e==r.Tree.WORLD&&n==r.Tree.NDC?this._screenToNDCLocation(this._worldToScreenLocation({point:t,pMatrix:s,vMatrix:i,pvMatrix:o})):e==r.Tree.NDC&&n==r.Tree.WORLD?this._screenToWorldLocation({point:this._ndcToScreenLocation(t),pMatrix:s,vMatrix:i,pvMatrix:o,ipvMatrix:c}):e==r.Tree.NDC&&(n instanceof r.Matrix||n==r.Tree.EYE)?(n==r.Tree.EYE?i??this.vMatrix():n.copy().invert(n)).mult4(this._screenToWorldLocation({point:this._ndcToScreenLocation(t),pMatrix:s,vMatrix:i,pvMatrix:o,ipvMatrix:c})):(e instanceof r.Matrix||e==r.Tree.EYE)&&n==r.Tree.NDC?this._screenToNDCLocation(this._worldToScreenLocation({point:(e==r.Tree.EYE?a??this.eMatrix():e).mult4(t),pMatrix:s,vMatrix:i,pvMatrix:o})):e==r.Tree.WORLD&&(n instanceof r.Matrix||n==r.Tree.EYE)?(n==r.Tree.EYE?i??this.vMatrix():n.copy().invert(n)).mult4(t):(e instanceof r.Matrix||e==r.Tree.EYE)&&n==r.Tree.WORLD?(e==r.Tree.EYE?a??this.eMatrix():e).mult4(t):e instanceof r.Matrix&&n instanceof r.Matrix?this.lMatrix({from:e,to:n}).mult4(t):e==r.Tree.SCREEN&&(n instanceof r.Matrix||n==r.Tree.EYE)?(n==r.Tree.EYE?i??this.vMatrix():n.copy().invert(n)).mult4(this._screenToWorldLocation({point:t,pMatrix:s,vMatrix:i,pvMatrix:o,ipvMatrix:c})):(e instanceof r.Matrix||e==r.Tree.EYE)&&n==r.Tree.SCREEN?this._worldToScreenLocation({point:(e==r.Tree.EYE?a??this.eMatrix():e).mult4(t),pMatrix:s,vMatrix:i,pvMatrix:o}):e instanceof r.Matrix&&n==r.Tree.EYE?(i??this.vMatrix()).mult4(e.mult4(t)):e==r.Tree.EYE&&n instanceof r.Matrix?n.copy().invert(n).mult4((a??this.eMatrix()).mult4(t)):(console.error("couldn't parse your mapLocation query!"),t)},r.RendererGL.prototype._ndcToScreenLocation=function(t){return new r.Vector(r.prototype.map(t.x,-1,1,0,this.width),r.prototype.map(t.y,-1,1,0,this.height),r.prototype.map(t.z,-1,1,0,1))},r.RendererGL.prototype._screenToNDCLocation=function(t){return new r.Vector(r.prototype.map(t.x,0,this.width,-1,1),r.prototype.map(t.y,0,this.height,-1,1),r.prototype.map(t.z,0,1,-1,1))},r.RendererGL.prototype._worldToScreenLocation=function({point:t=new r.Vector(0,0,.5),pMatrix:e,vMatrix:n,pvMatrix:s=this.pvMatrix({pMatrix:e,vMatrix:n})}={}){let i=s._mult4([t.x,t.y,t.z,1]);if(i[3]===0)return console.error("[p5.tree] World->Screen broken: check pvMatrix."),t.copy();const a=[0,this.height,this.width,-this.height];return i[0]/=i[3],i[1]/=i[3],i[2]/=i[3],i[0]=i[0]*.5+.5,i[1]=i[1]*.5+.5,i[2]=i[2]*.5+.5,i[0]=i[0]*a[2]+a[0],i[1]=i[1]*a[3]+a[1],new r.Vector(i[0],i[1],i[2])},r.RendererGL.prototype._screenToWorldLocation=function({point:t=new r.Vector(this.width/2,this.height/2,.5),pMatrix:e,vMatrix:n,pvMatrix:s,ipvMatrix:i=this.ipvMatrix({pMatrix:e,vMatrix:n,pvMatrix:s})}={}){const a=[0,this.height,this.width,-this.height],o=[t.x,t.y,t.z,1];o[0]=(o[0]-a[0])/a[2],o[1]=(o[1]-a[1])/a[3],o[0]=o[0]*2-1,o[1]=o[1]*2-1,o[2]=o[2]*2-1;let c=i._mult4(o);return c[3]===0?(console.error("[p5.tree] Screen->World broken: check ipvMatrix."),t.copy()):(c[0]/=c[3],c[1]/=c[3],c[2]/=c[3],new r.Vector(c[0],c[1],c[2]))},y.mapDirection=function(...t){return g(this)?.mapDirection(...t)},r.RendererGL.prototype.mapDirection=function(...t){const{mainArg:e,options:n}=this._parseTransformArgs(r.Tree._k,...t);return this._direction(e,n)},r.RendererGL.prototype._direction=function(t=r.Tree._k,{from:e=r.Tree.EYE,to:n=r.Tree.WORLD,vMatrix:s,eMatrix:i,pMatrix:a}={}){if(Array.isArray(t)&&(t=new r.Vector(t[0]??0,t[1]??0,t[2]??0)),e===r.Tree.MODEL&&(e=this.mMatrix({eMatrix:i})),n===r.Tree.MODEL&&(n=this.mMatrix({eMatrix:i})),e===r.Tree.WORLD&&n===r.Tree.SCREEN)return this._worldToScreenDirection(t,a);if(e===r.Tree.SCREEN&&n===r.Tree.WORLD)return this._screenToWorldDirection(t,a);if(e===r.Tree.SCREEN&&n===r.Tree.NDC)return this._screenToNDCDirection(t);if(e===r.Tree.NDC&&n===r.Tree.SCREEN)return this._ndcToScreenDirection(t);if(e===r.Tree.WORLD&&n===r.Tree.NDC)return this._screenToNDCDirection(this._worldToScreenDirection(t,a));if(e===r.Tree.NDC&&n===r.Tree.WORLD)return this._screenToWorldDirection(this._ndcToScreenDirection(t),a);if(e===r.Tree.NDC&&n===r.Tree.EYE)return this.dMatrix({matrix:i??this.eMatrix()}).multiplyVec3(this._screenToWorldDirection(this._ndcToScreenDirection(t),a));if(e===r.Tree.EYE&&n===r.Tree.NDC){const o=this.dMatrix({matrix:s??this.vMatrix()});return this._screenToNDCDirection(this._worldToScreenDirection(o.multiplyVec3(t),a))}if(e===r.Tree.SCREEN&&n instanceof r.Matrix)return this.dMatrix({matrix:n}).multiplyVec3(this._screenToWorldDirection(t,a));if(e instanceof r.Matrix&&n===r.Tree.SCREEN){const o=this.dMatrix({matrix:V(e)});return this._worldToScreenDirection(o.multiplyVec3(t),a)}if(e instanceof r.Matrix&&n instanceof r.Matrix)return this.dMatrix({from:e,to:n}).multiplyVec3(t);if(e===r.Tree.EYE&&n===r.Tree.WORLD)return this.dMatrix({matrix:s??this.vMatrix()}).multiplyVec3(t);if(e===r.Tree.WORLD&&n===r.Tree.EYE)return this.dMatrix({matrix:i??this.eMatrix()}).multiplyVec3(t);if(e===r.Tree.EYE&&n===r.Tree.SCREEN)return this._worldToScreenDirection(this.dMatrix({matrix:s??this.vMatrix()}).multiplyVec3(t),a);if(e===r.Tree.SCREEN&&n===r.Tree.EYE)return this.dMatrix({matrix:i??this.eMatrix()}).multiplyVec3(this._screenToWorldDirection(t,a));if(e===r.Tree.EYE&&n instanceof r.Matrix)return this.dMatrix({matrix:(s??this.vMatrix()).apply(n)}).multiplyVec3(t);if(e instanceof r.Matrix&&n===r.Tree.EYE)return this.dMatrix({matrix:V(e).apply(i??this.eMatrix())}).multiplyVec3(t);if(e===r.Tree.WORLD&&n instanceof r.Matrix)return this.dMatrix({matrix:n}).multiplyVec3(t);if(e instanceof r.Matrix&&n===r.Tree.WORLD)return this.dMatrix({matrix:V(e)}).multiplyVec3(t);if(e instanceof r.Matrix&&n===r.Tree.NDC){const o=this.dMatrix({matrix:V(e)});return this._screenToNDCDirection(this._worldToScreenDirection(o.multiplyVec3(t),a))}return e===r.Tree.NDC&&n instanceof r.Matrix?this.dMatrix({matrix:n}).multiplyVec3(this._screenToWorldDirection(this._ndcToScreenDirection(t),a)):(console.error("[p5.tree] mapDirection: could not parse query."),t)},r.RendererGL.prototype._worldToScreenDirection=function(t,e){e=e??this.pMatrix();const n=this._direction(t,{from:r.Tree.WORLD,to:r.Tree.EYE});let s=n.x,i=n.y;const a=e.mat4[15]===0;if(a){const c=this._location(r.Tree.ORIGIN,{from:r.Tree.WORLD,to:r.Tree.EYE}).z,f=Math.abs(c*Math.tan(e.fov()/2));s/=2*f/this.height,i/=2*f/this.height}let o=n.z;return o/=(e.nPlane()-e.fPlane())/(a?Math.tan(e.fov()/2):Math.abs(e.rPlane()-e.lPlane())/this.width),new r.Vector(s,i,o)},r.RendererGL.prototype._screenToWorldDirection=function(t,e){e=e??this.pMatrix();let n=t.x,s=t.y;const i=e.mat4[15]===0;if(i){const o=this._location(r.Tree.ORIGIN,{from:r.Tree.WORLD,to:r.Tree.EYE}).z,c=Math.abs(o*Math.tan(e.fov()/2));n*=2*c/this.height,s*=2*c/this.height}let a=t.z;return a*=(e.nPlane()-e.fPlane())/(i?Math.tan(e.fov()/2):Math.abs(e.rPlane()-e.lPlane())/this.width),this._direction(new r.Vector(n,s,a),{from:r.Tree.EYE,to:r.Tree.WORLD})},r.RendererGL.prototype._ndcToScreenDirection=function(t){return new r.Vector(this.width*t.x/2,this.height*t.y/2,t.z/2)},r.RendererGL.prototype._screenToNDCDirection=function(t){return new r.Vector(2*t.x/this.width,2*t.y/this.height,2*t.z)},y.pixelRatio=function(t){return g(this)?.pixelRatio(t)},r.RendererGL.prototype.pixelRatio=function(t=r.Tree.ORIGIN){return this.isOrtho()?Math.abs(this.tPlane()-this.bPlane())/this.height:2*Math.abs(this.mapLocation(t,{from:r.Tree.WORLD,to:r.Tree.EYE}).z)*Math.tan(this.fov()/2)/this.height},y.texOffset=function(t){return[1/t.width,1/t.height]},y.mousePosition=function(t=!0){const e=this.pixelDensity();return[e*this.mouseX,e*(t?this.height-this.mouseY:this.mouseY)]},y.pointerPosition=function(...t){return g(this)?.pointerPosition(...t)},y.resolution=function(){return g(this)?.resolution()},r.RendererGL.prototype.pointerPosition=function(...t){let e,n,s=!0;for(const a of t)typeof a=="number"?e===void 0?e=a:n=a:typeof a=="boolean"&&(s=a);const i=this.pixelDensity();return[i*e,i*(s?this.height-n:n)]},r.RendererGL.prototype.resolution=function(){const t=this.pixelDensity();return[t*this.width,t*this.height]},y.axes=function(t){return g(this)?.axes(t),this},r.RendererGL.prototype.axes=function({size:t=100,colors:e=["Red","Lime","DodgerBlue"],bits:n=r.Tree.LABELS|r.Tree.X|r.Tree.Y|r.Tree.Z}={}){const s=this._pInst;if(s){if(s.push(),(n&r.Tree.LABELS)!==0){const i=t/40,a=t/30,o=1.04*t;s.stroke(e[0%e.length]),s.line(o,i,-a,o,-i,a),s.line(o,-i,-a,o,i,a),s.stroke(e[1%e.length]),s.line(i,o,a,0,o,0),s.line(0,o,0,-i,o,a),s.line(-i,o,a,0,o,0),s.line(0,o,0,0,o,-a),s.stroke(e[2%e.length]),s.line(-i,-a,o,i,-a,o),s.line(i,-a,o,-i,a,o),s.line(-i,a,o,i,a,o)}s.stroke(e[0%e.length]),(n&r.Tree.X)!==0&&s.line(0,0,0,t,0,0),(n&r.Tree._X)!==0&&s.line(0,0,0,-t,0,0),s.stroke(e[1%e.length]),(n&r.Tree.Y)!==0&&s.line(0,0,0,0,t,0),(n&r.Tree._Y)!==0&&s.line(0,0,0,0,-t,0),s.stroke(e[2%e.length]),(n&r.Tree.Z)!==0&&s.line(0,0,0,0,0,t),(n&r.Tree._Z)!==0&&s.line(0,0,0,0,0,-t),s.pop()}},y.grid=function(t){return g(this)?.grid(t),this},r.RendererGL.prototype.grid=function({size:t=100,subdivisions:e=10}={}){const n=this._pInst;if(n){e=Math.max(1,e),n.push();for(let s=0;s<=e;++s){const i=t*(2*s/e-1);n.line(i,-t,0,i,+t,0),n.line(-t,i,0,+t,i,0)}n.pop()}},y.mousePicking=function(t){return g(this)?.mousePicking(t)},y.pointerPicking=function(...t){return g(this)?.pointerPicking(...t)},r.RendererGL.prototype.mousePicking=function({mMatrix:t=this.mMatrix(),x:e,y:n,size:s=50,shape:i=r.Tree.CIRCLE,eMatrix:a,pMatrix:o,vMatrix:c,pvMatrix:f}={}){const u=this._pInst;return u?this.pointerPicking(u.mouseX,u.mouseY,{mMatrix:t,x:e,y:n,size:s,shape:i,eMatrix:a,pMatrix:o,vMatrix:c,pvMatrix:f}):!1},r.RendererGL.prototype.pointerPicking=function(...t){let e,n;const s={};for(const _ of t)typeof _=="number"&&Number.isFinite(_)?e==null?e=_:n=_:_&&typeof _=="object"&&Object.assign(s,_);const i=this._pInst;e==null&&(e=i?i.mouseX:this.width/2),n==null&&(n=i?i.mouseY:this.height/2);let{mMatrix:a=this.mMatrix(),x:o,y:c,size:f=50,shape:u=r.Tree.CIRCLE,eMatrix:d,pMatrix:E,vMatrix:m,pvMatrix:T}=s;if(o==null||c==null){const _=this.mapLocation({from:a,to:r.Tree.SCREEN,pMatrix:E,vMatrix:m,pvMatrix:T});o=_.x,c=_.y;const p=this.mapLocation({from:a,to:r.Tree.WORLD,eMatrix:d});f=f/this.pixelRatio(p)}const R=f/2,P=o-e,b=c-n;return u===r.Tree.CIRCLE?Math.sqrt(P*P+b*b)<R:Math.abs(P)<R&&Math.abs(b)<R},r.RendererGL.prototype._circle=function({filled:t=!1,x:e=this.width/2,y:n=this.height/2,radius:s=100,detail:i=50}={}){const a=this._pInst;if(a){if(a.push(),a.translate(e,n),t){a.beginShape(a.TRIANGLE_STRIP);for(let o=0;o<=i;o++){const c=Math.cos(o*(2*Math.PI)/i),f=Math.sin(o*(2*Math.PI)/i);a.vertex(0,0,0,.5,.5),a.vertex(s*c,s*f,0,c*.5+.5,f*.5+.5)}a.endShape()}else{const o=2*Math.PI/i;let c={x:s,y:0};for(let f=1;f<=i;f++){const u={x:Math.cos(f*o)*s,y:Math.sin(f*o)*s};a.line(c.x,c.y,u.x,u.y),c=u}}a.pop()}},y.cross=function(t){return g(this)?.cross(t),this},r.RendererGL.prototype.cross=function({mMatrix:t=this.mMatrix(),x:e,y:n,size:s=50,eMatrix:i,pMatrix:a,vMatrix:o,pvMatrix:c}={}){const f=this._pInst;if(!f)return;if(e==null||n==null){const d=this.mapLocation({from:t,to:r.Tree.SCREEN,pMatrix:a,vMatrix:o,pvMatrix:c});e=d.x,n=d.y;const E=this.mapLocation({from:t,to:r.Tree.WORLD,eMatrix:i});s=s/this.pixelRatio(E)}const u=s/2;this.beginHUD(),f.line(e-u,n,e+u,n),f.line(e,n-u,e,n+u),this.endHUD()},y.bullsEye=function(t){return g(this)?.bullsEye(t),this},r.RendererGL.prototype.bullsEye=function({mMatrix:t=this.mMatrix(),x:e,y:n,size:s=50,shape:i=r.Tree.CIRCLE,eMatrix:a,pMatrix:o,vMatrix:c,pvMatrix:f}={}){const u=this._pInst;if(!u)return;if(e==null||n==null){const T=this.mapLocation({from:t,to:r.Tree.SCREEN,pMatrix:o,vMatrix:c,pvMatrix:f});e=T.x,n=T.y;const R=this.mapLocation({from:t,to:r.Tree.WORLD,eMatrix:a});s=s/this.pixelRatio(R)}const d=s/2,E=.6*d;this.beginHUD(),i===r.Tree.CIRCLE?this._circle({x:e,y:n,radius:d}):(u.line(e-d,n-d+E,e-d,n-d),u.line(e-d,n-d,e-d+E,n-d),u.line(e+d-E,n-d,e+d,n-d),u.line(e+d,n-d,e+d,n-d+E),u.line(e+d,n+d-E,e+d,n+d),u.line(e+d,n+d,e+d-E,n+d),u.line(e-d+E,n+d,e-d,n+d),u.line(e-d,n+d,e-d,n+d-E));const m=.6*d;u.line(e-m,n,e+m,n),u.line(e,n-m,e,n+m),this.endHUD()},y.viewFrustum=function(t){return g(this)?.viewFrustum(t),this},r.RendererGL.prototype.viewFrustum=function({vMatrix:t=this.vMatrix(),pg:e,eMatrix:n=e?.eMatrix(),pMatrix:s=e?.pMatrix(),bits:i=r.Tree.NEAR|r.Tree.FAR,viewer:a=()=>this.axes({size:50,bits:r.Tree.X|r.Tree._X|r.Tree.Y|r.Tree._Y|r.Tree.Z|r.Tree._Z})}={}){const o=this._pInst;if(!o)return;if(this===e){console.error("displaying viewFrustum requires a pg different than this");return}if(!s||!n){console.error("displaying viewFrustum requires either a pg or projection and eye matrices");return}const f=this.states?.uViewMatrix;if(!f)return;o.push(),o.resetMatrix();const u=f.copy();f.set(t),this.applyMatrix(...n.mat4),typeof a=="function"&&a();const d=s.isOrtho(),E=!d&&(i&r.Tree.APEX)!==0,m=-s.nPlane(),T=-s.fPlane(),R=s.lPlane(),P=s.rPlane(),b=d?-s.tPlane():s.tPlane(),_=d?-s.bPlane():s.bPlane(),p=d?1:T/m,h=p*R,l=p*P,L=p*_,M=p*b;(i&r.Tree.FAR)!==0?(this.beginShape(),this.vertex(h,M,T),this.vertex(l,M,T),this.vertex(l,L,T),this.vertex(h,L,T),this.endShape(r.prototype.CLOSE)):(this.line(h,M,T,l,M,T),this.line(l,M,T,l,L,T),this.line(l,L,T,h,L,T),this.line(h,L,T,h,M,T)),(i&r.Tree.BODY)!==0?(this.beginShape(),this.vertex(h,M,T),this.vertex(R,b,m),this.vertex(P,b,m),this.vertex(l,M,T),this.endShape(),this.beginShape(),this.vertex(l,M,T),this.vertex(P,b,m),this.vertex(P,_,m),this.vertex(l,L,T),this.endShape(),this.beginShape(),this.vertex(l,L,T),this.vertex(P,_,m),this.vertex(R,_,m),this.vertex(h,L,T),this.endShape(),this.beginShape(),this.vertex(R,b,m),this.vertex(h,M,T),this.vertex(h,L,T),this.vertex(R,_,m),this.endShape(),E&&(this.line(0,0,0,P,b,m),this.line(0,0,0,R,b,m),this.line(0,0,0,R,_,m),this.line(0,0,0,P,_,m))):(this.line(E?0:P,E?0:b,E?0:m,l,M,T),this.line(E?0:R,E?0:b,E?0:m,h,M,T),this.line(E?0:R,E?0:_,E?0:m,h,L,T),this.line(E?0:P,E?0:_,E?0:m,l,L,T)),(i&r.Tree.NEAR)!==0?(this.beginShape(),this.vertex(R,b,m),this.vertex(P,b,m),this.vertex(P,_,m),this.vertex(R,_,m),this.endShape(r.prototype.CLOSE)):(this.line(R,b,m,P,b,m),this.line(P,b,m,P,_,m),this.line(P,_,m,R,_,m),this.line(R,_,m,R,b,m)),f.set(u),o.pop()},y.visibility=function(...t){return g(this).visibility(...t)},y.bounds=function(t={}){return g(this).bounds(t)},y.distanceToBound=function(...t){return g(this).distanceToBound(...t)},r.RendererGL.prototype._parseVisibilityArgs=function(...t){let e,n,s,i,a,o;const c=[],f=u=>!u||typeof u!="object"||Array.isArray(u)||ArrayBuffer.isView(u)?!1:Object.getPrototypeOf(u)===Object.prototype;for(const u of t){if(u instanceof r.Vector||Array.isArray(u)){c.push(u);continue}if(typeof u=="number"&&Number.isFinite(u)&&i===void 0){s?i=u:a=u;continue}f(u)&&("corner1"in u||"corner2"in u||"center"in u||"radius"in u||"bounds"in u?(e=u.corner1??e,n=u.corner2??n,s=u.center??s,i=u.radius??i,o=u.bounds??o):o=u)}return!e&&!n&&(!s&&c.length===1?s=c[0]:!e&&!n&&c.length>=2&&(e=c[0],n=c[1])),i===void 0&&a!==void 0&&s&&(i=a),{corner1:e,corner2:n,center:s,radius:i,bounds:o}},r.RendererGL.prototype.visibility=function(...t){const{corner1:e,corner2:n,center:s,radius:i,bounds:a}=this._parseVisibilityArgs(...t),o=a??this.bounds();return s?i?this._ballVisibility(s,i,o):this._pointVisibility(s,o):e&&n?this._boxVisibility(e,n,o):(console.error("[p5.tree] visibility: could not parse query."),r.Tree.INVISIBLE)},r.RendererGL.prototype._pointVisibility=function(t,e=this.bounds()){for(const n in e){const s=this.distanceToBound(t,n,e);if(s>0)return r.Tree.INVISIBLE;if(s===0)return r.Tree.SEMIVISIBLE}return r.Tree.VISIBLE},r.RendererGL.prototype._ballVisibility=function(t,e,n=this.bounds()){let s=!0;for(const i in n){const a=this.distanceToBound(t,i,n);if(a>e)return r.Tree.INVISIBLE;(a>0||-a<e)&&(s=!1)}return s?r.Tree.VISIBLE:r.Tree.SEMIVISIBLE},r.RendererGL.prototype._boxVisibility=function(t,e,n=this.bounds()){const s=a=>a instanceof r.Vector?a:new r.Vector(a?.[0]??0,a?.[1]??0,a?.[2]??0);t=s(t),e=s(e);let i=!0;for(const a in n){let o=!0;for(let c=0;c<8;++c){const f=new r.Vector((c&4)!==0?t.x:e.x,(c&2)!==0?t.y:e.y,(c&1)!==0?t.z:e.z);this.distanceToBound(f,a,n)>0?i=!1:o=!1}if(o)return r.Tree.INVISIBLE}return i?r.Tree.VISIBLE:r.Tree.SEMIVISIBLE},r.RendererGL.prototype.bounds=function({vMatrix:t,eMatrix:e}={}){const n=this.nPlane(),s=this.fPlane(),i=this.lPlane(),a=this.rPlane(),o=this.bPlane(),c=this.tPlane(),f=Array(6),u=Array(6),d=this._location([0,0,0],{from:r.Tree.EYE,to:r.Tree.WORLD,eMatrix:e}),E=this._direction([0,0,-1],{from:r.Tree.EYE,to:r.Tree.WORLD,vMatrix:t}),m=this._direction([0,1,0],{from:r.Tree.EYE,to:r.Tree.WORLD,vMatrix:t}),T=this._direction([1,0,0],{from:r.Tree.EYE,to:r.Tree.WORLD,vMatrix:t}),R=r.Vector.dot(d,E);if(this.isOrtho())f[0]=r.Vector.mult(T,-1),f[1]=T,f[4]=m,f[5]=r.Vector.mult(m,-1),u[0]=r.Vector.dot(r.Vector.sub(d,r.Vector.mult(T,-i)),f[0]),u[1]=r.Vector.dot(r.Vector.add(d,r.Vector.mult(T,a)),f[1]),u[4]=r.Vector.dot(r.Vector.add(d,r.Vector.mult(m,-o)),f[4]),u[5]=r.Vector.dot(r.Vector.sub(d,r.Vector.mult(m,c)),f[5]);else{const b=Math.atan2(a,n),_=Math.sin(b),p=Math.cos(b),h=Math.atan2(i,n),l=Math.sin(h),L=Math.cos(h);f[0]=r.Vector.add(r.Vector.mult(E,l),r.Vector.mult(T,-L)),f[1]=r.Vector.add(r.Vector.mult(E,-_),r.Vector.mult(T,p));const M=Math.atan2(c,n),S=Math.sin(M),O=Math.cos(M),D=Math.atan2(o,n),w=Math.sin(D),Y=Math.cos(D);f[4]=r.Vector.add(r.Vector.mult(E,-S),r.Vector.mult(m,O)),f[5]=r.Vector.add(r.Vector.mult(E,w),r.Vector.mult(m,-Y)),u[0]=l*R-L*r.Vector.dot(d,T),u[1]=-_*R+p*r.Vector.dot(d,T),u[4]=-S*R+O*r.Vector.dot(d,m),u[5]=w*R-Y*r.Vector.dot(d,m)}f[2]=r.Vector.mult(E,-1),f[3]=E,u[2]=-R-n,u[3]=R+s;const P={};return P[r.Tree.LEFT]={a:f[0].x,b:f[0].y,c:f[0].z,d:u[0]},P[r.Tree.RIGHT]={a:f[1].x,b:f[1].y,c:f[1].z,d:u[1]},P[r.Tree.NEAR]={a:f[2].x,b:f[2].y,c:f[2].z,d:u[2]},P[r.Tree.FAR]={a:f[3].x,b:f[3].y,c:f[3].z,d:u[3]},P[r.Tree.TOP]={a:f[4].x,b:f[4].y,c:f[4].z,d:u[4]},P[r.Tree.BOTTOM]={a:f[5].x,b:f[5].y,c:f[5].z,d:u[5]},P},r.RendererGL.prototype.distanceToBound=function(...t){let e,n,s=this.bounds();const i=o=>o instanceof r.Vector?o:new r.Vector(o?.[0]??0,o?.[1]??0,o?.[2]??0);for(const o of t)o instanceof r.Vector||Array.isArray(o)?e=i(o):typeof o=="string"||typeof o=="number"?n=o:o&&typeof o=="object"&&!Array.isArray(o)&&(s=o);if(!e||n===void 0)return console.error("[p5.tree] distanceToBound: could not parse query."),0;const a=s[n];return r.Vector.dot(e,new r.Vector(a.a,a.b,a.c))-a.d}});
